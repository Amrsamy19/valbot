

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Source: commands.js | Valarium Bot Documentation</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/bootstrap.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-jsdoc.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/tui-doc.css">

    
</head>
<body>
<nav class="lnb" id="lnb">
    <div class="logo" style="">
        
            <a href="function link() { [native code] }" rel="noopener noreferrer" target="_blank">
                <img src="img/toast-ui.png" width="100%" height="100%">
            </a>
        
    </div>
    <div class="title">
        <h1><a href="index.html" class="link">Valarium Bot Documentation</a></h1>
        
    </div>
    <div class="search-container" id="search-container">
        <input type="text" placeholder="Search">
        <ul></ul>
    </div>
    
    <div class="lnb-api hidden"><h3>Namespaces</h3><ul><li><a href="BOT_COMMANDS.html">BOT_COMMANDS</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="BOT_COMMANDS_sub"></div></li><li><a href="BOT_COMMANDS.helpers.html">BOT_COMMANDS.helpers</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="BOT_COMMANDS.helpers_sub"></div></li><li><a href="BOT_COMMANDS.mod.html">BOT_COMMANDS.mod</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="BOT_COMMANDS.mod_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="BOT_COMMANDS.mod.html#..ban">.ban</a></li><li><a href="BOT_COMMANDS.mod.html#..clear">.clear</a></li><li><a href="BOT_COMMANDS.mod.html#..clear">.clear</a></li><li><a href="BOT_COMMANDS.mod.html#..dmAllMembers">.dmAllMembers</a></li><li><a href="BOT_COMMANDS.mod.html#..reactionRoles">.reactionRoles</a></li><li><a href="BOT_COMMANDS.mod.html#..warn">.warn</a></li><li><a href="BOT_COMMANDS.mod.html#..warnings">.warnings</a></li></ul></div></li><li><a href="BOT_COMMANDS.org.html">BOT_COMMANDS.org</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="BOT_COMMANDS.org_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="BOT_COMMANDS.org.html#..mute">.mute</a></li><li><a href="BOT_COMMANDS.org.html#..unmute">.unmute</a></li></ul></div></li></ul></div><div class="lnb-api hidden"><h3>Global</h3><ul><li><a href="global.html#checkWatchedMessage">checkWatchedMessage</a></li><li><a href="global.html#handleMessage">handleMessage</a></li><li class="hidden"><a href="global.html#Message">Message</a></li></ul></div>
</nav>
<div id="resizer"></div>

<div class="main" id="main">
    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const { RichEmbed } = require('discord.js')



/**
 * @since 1.0.0
 * @type {Object}
 * @namespace BOT_COMMANDS
 * @property {Object} org Methods used for organising
 * @property {Object} mod Methods used for moderation 
 * @property {Object} helpers Methods used in org/mod
 */
let BOT_COMMANDS =  {
  /**
   * @since 1.0.0
   * @type {Object}
   * @memberof! BOT_COMMANDS
   * @property {Function} mute
   * @property {Function} unmute
   * @namespace org
   */
  org: {
    /**
    * @description Used to mute members in voice and text channels. This mute is automatically removed after 15 minutes
    * @since 1.0.0
    * @method mute
    * @param {Message} commandMessage The command message containing command parameters
    * @param {Array} args `commandMessage` split using String.prototype.split(' ')
    * @param {Object} __ENV
    * @memberof! BOT_COMMANDS.org
    * @example
    * Discord_Client.on('message', ()=>{mute(message, message.content.split(' '), __ENV)}))
    */
    mute: async (commandMessage, args, __ENV)=>{
      try{
        let mutedMember = await __ENV.__VALARIUM_GUILD().fetchMember(args[3].toString().replace(/&lt;|>|@/ig, ''))
        let slicedReason = args.slice(5).join(' ') || 'Violation of the rules'
        let date = new Date().toString()
        
        mutedMember.addRole('586839490102951936', args[4])
        console.log(mutedMember.roles.some(role => role.id === '586839490102951936'))
        !mutedMember.roles.some(role => role.id === '586839490102951936') ? mutedMember.addRole('586839490102951936'): commandMessage.reply('this user is already muted')

        BOT_COMMANDS.helpers.sendEmbedNotification(
          __ENV, undefined, 
          {
            author: commandMessage.author, 
            description: `${mutedMember} has been muted at ${date} by ${commandMessage.member}`, 
            title:`INFO, ${mutedMember}`, 
            color: 0xfade78,
            footer: date
          }, [
            {name: 'Member', value: `${mutedMember}`}, 
            {name: 'Moderator', value: `${commandMessage.member}`}, 
            {name: 'Reason', value: slicedReason}, 
            {name: 'Status', value: `This user is now muted and will be automatically unmuted in 15 minutes`}
          ], 
          undefined, 
          [__ENV.__MODERATION_NOTICES_CHANNEL()])
        
        setTimeout(()=>{BOT_COMMANDS.org.unmute(commandMessage, args, __ENV)}, 900000) //15 minutes 900000 ms
      }
      catch(err){console.log(err)}
    },
    /**
     * @description Used to unmute muted members in voice and text channels.
     * @since 1.0.0
     * @method unmute
     * @param {Message} commandMessage The command message containing command parameters
     * @param {Array} args `commandMessage` split using String.prototype.split(' ')
     * @param {Object} __ENV
     * @memberof! BOT_COMMANDS.org
     * @example
     * //This probably requires more verification
     * Discord_Client.on('message', ()=>{unmute(message, message.content.split(' '), __ENV)}))
     */
    unmute: async (commandMessage, args, __ENV)=>{
      try{
        let mutedMember = await __ENV.__VALARIUM_GUILD().fetchMember(args[3].toString().replace(/&lt;|>|@/ig, ''))
        let date = new Date().toString()
        console.log(mutedMember.roles.some(role => role.id === '586839490102951936'))
        mutedMember.roles.some(role => role.id === '586839490102951936')? mutedMember.removeRole('586839490102951936'): commandMessage.reply('this user is not muted')
        
        BOT_COMMANDS.helpers.sendEmbedNotification(
          __ENV, undefined, 
          {
            author: commandMessage.author, 
            description: `${mutedMember} has been unmuted at ${date} by ${commandMessage.member}`, 
            title:`INFO, ${mutedMember}`, 
            color: 0xfade78,
            footer: date
          }, [
            {name: 'Member', value: `${mutedMember}`}, 
            {name: 'Moderator', value: `${commandMessage.member}`}, 
            {name: 'Status', value: `This user is now unmuted. Happy talking!`}
          ], 
          undefined, 
          [__ENV.__MODERATION_NOTICES_CHANNEL()])
      }
      catch(err){console.log(err)}
    }
  },
  /**
   * @since 1.0.0
   * @type {Object}
   * @memberof! BOT_COMMANDS
   * @property {Function} clear
   * @property {Function} warn
   * @property {Function} warnings
   * @property {Function} reactionRoles
   * @property {Function} ban
   * @property {Function} unban
   * @namespace mod
   */
  mod: {
    /**
     * @description Sends a specific message to all members of the guild
     * @since 1.0.0
     * @method dmAllMembers
     * @param {Message} commandMessage The command message containing command parameters
     * @param {Array} args `commandMessage` split using String.prototype.split(' ')
     * @param {Object} __ENV
     * @memberof! BOT_COMMANDS.mod
     */
    dmAllMembers: async (commandMessage, args, __ENV)=>{
      try{
        __ENV.__VALARIUM_GUILD().members.forEach(async member=>{
          let memberDM = await member.createDM()
          await memberDM.send(args[3])
        })
      }
      catch(err){
        console.log(err)
      }
    },
    /**
     * @description Deletes the supplied number of messages (defaults to 5)
     * @since 1.0.0
     * @method clear
     * @param {Message} commandMessage The command message containing command parameters
     * @param {Array} args `commandMessage` split using String.prototype.split(' ')
     * @param {Object} __ENV
     * @memberof! BOT_COMMANDS.mod
     * @example
     * //This probably requires more verification
     * Discord_Client.on('message', ()=>{clear(message, message.content.split(' '), __ENV)}))
     */
    clear: async (commandMessage, args, __ENV)=>{
      try{
        let deletedMessages = await commandMessage.channel.bulkDelete(args[3]? parseInt(args[3]): 5)
        deletedMessages = deletedMessages.map(message=>({author: {name: message.author.username, id: message.author.id}, content: message.content}))
        await __ENV.__DATABASE_OBJECT.collection('DELETED_MESSAGES').insertMany(deletedMessages)
      }
      catch(err){
        console.log(err)
      }
    },
    /**
     * @description Adds a warning to a member. When a member has 3 or more warnings they'll be banned
     * @since 1.0.0
     * @method warn
     * @param {Message} commandMessage The command message containing command parameters
     * @param {Array} args `commandMessage` split using String.prototype.split(' ')
     * @param {Object} __ENV
     * @memberof! BOT_COMMANDS.mod
     * @example
     * //This probably requires more verification
     * Discord_Client.on('message', ()=>{warn(message, message.content.split(' '), __ENV)}))
     */
    warn: async (commandMessage, args, __ENV)=>{
      try{
        let warnedMember = await __ENV.__VALARIUM_GUILD().fetchMember(args[3].toString().replace(/&lt;|>|@/ig, ''))
        let slicedReason = args.slice(5).join(' ')

        let userWarnings = (await __ENV.__DATABASE_OBJECT.collection('GUILD_WARNINGS').findOneAndUpdate({USER_ID: warnedMember.id}, {
          '$push': { 
            RECORDED_WARNINGS: {
              WARNING_REASON_NAME: args[4],
              WARNING_REASON_DESCRIPTION: slicedReason,
              WARNING_DATE: new Date().toString()
            }   
          }
        }, {upsert: true, returnOriginal: false})).value

        let date = new Date().toString()
        
        BOT_COMMANDS.helpers.sendEmbedNotification(
          __ENV, warnedMember, 
          {
            author: commandMessage.author, 
            description: `${warnedMember} has been warned at ${date} by ${commandMessage.member}`, 
            title:`WARNING, ${warnedMember}`, 
            color: 0xfade78,
            footer: date
          }, [
            {name: 'Member', value: `${warnedMember}`}, 
            {name: 'Moderator', value: `${commandMessage.member}`}, 
            {name: 'Reason', value: slicedReason}, 
            {name: 'Status', value: `This user now has ${userWarnings.RECORDED_WARNINGS.length} warnings`}
          ], 
          [], 
          [__ENV.__MODERATION_NOTICES_CHANNEL()])

        if(userWarnings.RECORDED_WARNINGS.length === 3){
          BOT_COMMANDS.mod.ban(commandMessage, args, __ENV, 'Warned 3 times')
        }
      }
      catch(err){console.log(err)}
    },
    /**
     * @description Tells the number of warnings a user has
     * @since 1.0.0
     * @method warnings
     * @param {Message} commandMessage The command message containing command parameters
     * @param {Array} args `commandMessage` split using String.prototype.split(' ')
     * @param {Object} __ENV
     * @memberof! BOT_COMMANDS.mod
     * @example
     * //This probably requires more verification
     * Discord_Client.on('message', ()=>{warnings(message, message.content.split(' '), __ENV)}))
     */
    warnings: async (commandMessage, args, __ENV)=>{
      try{
        let warnedMember = await __ENV.__VALARIUM_GUILD().fetchMember(args[3].toString().replace(/&lt;|>|@/ig, ''))
        let userWarnings = await BOT_COMMANDS.helpers.getWarnings(warnedMember, __ENV)
        let fields = []

        if(userWarnings &amp;&amp; userWarnings.RECORDED_WARNINGS){
          fields = userWarnings.RECORDED_WARNINGS.map(( warning => ({name: warning.WARNING_REASON_NAME, value:
            warning.WARNING_REASON_DESCRIPTION})))
        }
        
        BOT_COMMANDS.helpers.sendEmbedNotification(
          __ENV, undefined,
          {
            author: commandMessage.author,  
            title:`WARNING LOG, ${warnedMember}`, 
            color: 0xfade78
          }, [
            ...fields,
            {name: 'Member', value: `${warnedMember}`}, 
            {name: 'Moderator', value: `${commandMessage.member}`}, 
            {name: 'Status', value: `This user has ${fields.length} warnings`}
          ], 
          undefined, 
          undefined, 
          (embed)=>{commandMessage.reply(embed)}
        )
      }
      catch(err){console.log(err)}
    },
    /**
     * @description Adds a reaction collector to a message to give roles. Used for adding self-roles
     * @since 1.0.0
     * @method reactionRoles
     * @param {Message} commandMessage The command message containing command parameters
     * @param {Array} args `commandMessage` split using String.prototype.split(' ')
     * @param {Object} __ENV
     * @memberof! BOT_COMMANDS.mod
     * @example
     * //This probably requires more verification
     * Discord_Client.on('message', ()=>{reactionRoles(message, message.content.split(' '), __ENV)}))
     */
    reactionRoles: async (commandMessage, args, __ENV)=>{
      try{
        let reactionMessage = await commandMessage.guild.channels.find(ch => `&lt;#${ch.id}>` === args[3]).fetchMessage(args[4])
        let index = 0 
        let expectedReaction = {}
        let botMessage
        let originalCommand = commandMessage.content.toString()

        const inputCollector = commandMessage.createReactionCollector(reaction => reaction)
        botMessage = await commandMessage.reply('please react to the previous message with the reaction you want!')

        inputCollector.on('collect', async reaction=>{
          expectedReaction.name = reaction.emoji.name
          await botMessage.edit('What\'s the expected role for that reaction? Update your message to reflect that!')

          __ENV.__VALARIUM_CLIENT.on('messageUpdate', async (oldMessage, newMessage)=>{
            if(oldMessage.content === originalCommand){
              if(__ENV.__AVAILABLE_ROLES.find(role => role.name === newMessage.content)){
                await reactionMessage.react(reaction.emoji.name)
                botMessage.edit('Successful. Awaiting reactions.')
                
                expectedReaction.role = newMessage.content
                //TODO: FIX ISSUES WITH REACTING AFTER RECORDING THROWING
                const userReactionsCollector = reactionMessage.createReactionCollector(reaction=>reaction.emoji.name === expectedReaction.name)
                __ENV.__DATABASE_OBJECT.collection('WATCHED_MESSAGES').updateOne({
                  CHANNEL_ID: reactionMessage.channel.id,
                  MESSAGE_ID: reactionMessage.id
                },{
                  '$addToSet': { 
                    WATCHED_REACTIONS: {
                      REACTION_NAME: reaction.emoji.name,
                      REACTION_ROLE_ID: __ENV.__AVAILABLE_ROLES.find(role => role.name === newMessage.content).id,
                      REACTION_ROLE_NAME: newMessage.content
                    } 
                  }
                }, {upsert: true})
                
                userReactionsCollector.on('collect', async reaction=>{
                  let users = await reaction.fetchUsers()
                  users.forEach(async user=>{
                    let member = await reactionMessage.guild.fetchMember(user.id)
                    member.addRole(__ENV.__AVAILABLE_ROLES.find(role => role.name === newMessage.content))
                  })
                })
              }
              else{
                commandMessage.reply('that role was not found')
              }
            }
          })
        })
      }
      catch(err){
        console.error(err)
      }
    },
    /**
     * @description Bans a member
     * @since 1.0.0
     * @method ban
     * @param {Message} commandMessage The command message containing command parameters
     * @param {Array} args `commandMessage` split using String.prototype.split(' ')
     * @param {Object} __ENV
     * @param {String} reason The reason for the ban, used for audit logs
     * @memberof! BOT_COMMANDS.mod
     * @example
     * //This probably requires more verification
     * Discord_Client.on('message', ()=>{ban(message, message.content.split(' '), __ENV)}))
     */
    ban: async function(commandMessage, args, __ENV, reason){
      try{
        let bannedMember = await __ENV.__VALARIUM_GUILD().fetchMember(args[3].toString().replace(/&lt;|>|@/ig, ''))
        let userWarnings = BOT_COMMANDS.mod.warnings(commandMessage, args, __ENV)
        let date = new Date().toString()

        bannedMember.ban({days: 3, reason})
        
        BOT_COMMANDS.helpers.sendEmbedNotification(__ENV, bannedMember, 
          {
            author: commandMessage.author, 
            description: `${bannedMember} has been warned at ${date} by ${commandMessage.member}`, 
            title:`BAN, ${bannedMember}`, 
            color: 0xfade78,
            footer: date
          }, [
            {name: 'Member', value: `${bannedMember}`}, 
            {name: 'Moderator', value: `${commandMessage.member}`}, 
            {name: 'Reason', value: reason}, 
            {name: 'Status', value: userWarnings.RECORDED_WARNINGS.length === 3? 'This user is now banned': `This user now has ${userWarnings.RECORDED_WARNINGS.length} warnings`}
          ], )
      }
      catch(err){ console.log(err) }
    },
    /**
     * @description Unbans a member
     * @since 1.0.0
     * @method clear
     * @param {Message} commandMessage The command message containing command parameters
     * @param {Array} args `commandMessage` split using String.prototype.split(' ')
     * @param {Object} __ENV
     * @param {String} reason The reason for the unban, used for audit logs
     * @memberof! BOT_COMMANDS.mod
     * @example
     * //This probably requires more verification
     * Discord_Client.on('message', ()=>{unban(message, message.content.split(' '), __ENV)}))
     */
    unban: async function(commandMessage, args, __ENV, reason){
      try{
        let bannedMember = await __ENV.__VALARIUM_CLIENT.fetchUser(args[3].toString().replace(/&lt;|>|@/ig, ''), {cache: true})

        await __ENV.__VALARIUM_GUILD().unban(bannedMember, reason)

        BOT_COMMANDS.helpers.sendEmbedNotification(__ENV, bannedMember, { 
          author: 'VALARIUM', description: 'You\'ve been unbanned from Valarium. Enjoy your stay :tada::hugging:!', title:'NOTIFICATION FROM VALARIUM', color: 0xfade78
        }, [{name: 'Mod: ', value: commandMessage.author}])
      }
      catch(err){console.log(err)}
    },
  },  
  /**
   * @since 1.0.0
   * @type {Object}
   * @memberof! BOT_COMMANDS
   * @property {Function} sendEmbedNotification
   * @property {Function} getWarnings
   * @namespace helpers
   */
  helpers:{
    sendEmbedNotification: async function(__ENV, member = undefined, embedOptions, fields, attachments = undefined, channels = undefined, callback){
      try{
        let embed = new RichEmbed(embedOptions)
        if(fields.length > 0){
          fields.forEach(field => field.name==='Moderator' || field.name==='Member'? embed.addField(field.name, field.value, true): embed.addField(field.name, field.value))
        }
        if(attachments){
          attachments.forEach(attachment=>{
            embed.attachFile(attachment.path)
          })
        }
        embed.setThumbnail('https://lh4.googleusercontent.com/Yic_fQ7O-bo2q1ELjzBTQaR3ljVG-coyKsj87E55QzuxrH4b0K1F2ZchjFVrQ_QBA93fc1xWczkD7LGPMTsO')
        if(channels){
          channels.forEach(channel=>{
            channel.send(embed)
          })
        }
        if(member){
          let DMChannel = await member.createDM()
          DMChannel.send(embed)
        }
        if(callback){
          callback(embed)
        }
      }
      catch(err){console.log(err)}
    },
    getWarnings: async (warnedMember, __ENV)=>{
      try{
        let warnings = await __ENV.__DATABASE_OBJECT.collection('GUILD_WARNINGS').findOne({USER_ID: warnedMember.id})
        return warnings
      }
      catch(err){console.log(err)}
    }
  }
}

module.exports = BOT_COMMANDS</code></pre>
        </article>
    </section>




</div>

<footer>
    <img class="logo" src="img/toast-ui.png" style="">
    <div class="footer-text">This documentation is not complete yet and is subject to change</div>
</footer>
<script>prettyPrint();</script>
<script src="scripts/jquery.min.js"></script>
<script src="scripts/tui-doc.js"></script>
<script src="scripts/linenumber.js"></script>

    <script>
        var id = '_sub'.replace(/"/g, '_');
        var selectedApi = document.getElementById(id); // do not use jquery selector
        var $selectedApi = $(selectedApi);

        $selectedApi.removeClass('hidden');
        $selectedApi.parent().find('.glyphicon').removeClass('glyphicon-plus').addClass('glyphicon-minus');
        showLnbApi();
    </script>

</body>
</html>
