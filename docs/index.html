<!DOCTYPE html>

<html>
<head>
  <title>index.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>index.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>INDEX</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> Discord = <span class="hljs-built_in">require</span>(<span class="hljs-string">'discord.js'</span>)
<span class="hljs-keyword">const</span> {prefix, token} = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./config.json'</span>)

<span class="hljs-keyword">const</span> insults = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./insults'</span>)
<span class="hljs-keyword">const</span> BOT_COMMANDS = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./commands'</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Contains all environment constants without the need for <code>process.env</code>.</p>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>The values are empty by default to wait till the connection to the database and server has been established to avoid runtime errors</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">const</span> __ENV = {
  <span class="hljs-attr">__DATABASE_OBJECT</span>: {},
  <span class="hljs-attr">__AVAILABLE_ROLES</span>: {},
  <span class="hljs-attr">__WATCHED_MESSAGES</span>: {},
  <span class="hljs-attr">__VALARIUM_CLIENT</span>: <span class="hljs-built_in">require</span>(<span class="hljs-string">'./client'</span>).__VALARIUM_CLIENT,
  <span class="hljs-attr">__VALARIUM_GUILD</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{<span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.__VALARIUM_CLIENT.guilds.find(<span class="hljs-function"><span class="hljs-params">guild</span>=&gt;</span>guild.name === <span class="hljs-string">'VALARIUM'</span>)},
  <span class="hljs-attr">__MODERATION_NOTICES_CHANNEL</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{<span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.__VALARIUM_GUILD().channels.find(<span class="hljs-function"><span class="hljs-params">channel</span>=&gt;</span> channel.id === <span class="hljs-string">'587571479173005312'</span>)}
}

__ENV.__VALARIUM_CLIENT.once(<span class="hljs-string">'ready'</span>, <span class="hljs-keyword">async</span> () =&gt; {
  <span class="hljs-keyword">try</span>{
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Ready!'</span>)

    __ENV.__DATABASE_OBJECT = <span class="hljs-keyword">await</span> <span class="hljs-built_in">require</span>(<span class="hljs-string">'./dbconnect'</span>).getDB()
    __ENV.__AVAILABLE_ROLES = <span class="hljs-keyword">await</span> __ENV.__DATABASE_OBJECT.collection(<span class="hljs-string">'AVAILABLE_ROLES'</span>).find({}).project({<span class="hljs-attr">_id</span>:<span class="hljs-number">0</span>}).toArray()
    __ENV.__WATCHED_MESSAGES = <span class="hljs-keyword">await</span> __ENV.__DATABASE_OBJECT.collection(<span class="hljs-string">'WATCHED_MESSAGES'</span>).find({}).toArray()
  
  <span class="hljs-keyword">await</span> __ENV.__DATABASE_OBJECT.collection(<span class="hljs-string">'warnings'</span>).deleteMany()
  }
  <span class="hljs-keyword">catch</span>(err){<span class="hljs-built_in">console</span>.log(<span class="hljs-string">`Couldn't execute __ENV.__VALARIUM_CLIENT.once(..) <span class="hljs-subst">${err}</span>`</span>)}
})

<span class="hljs-comment">/**
 * Checks whether a message is being watched for reactions
 * @function
 * @name checkWatchedMessage
 * @param {Message} message The message object to check
 * @return {Document} The watched message fetched from DB
 * @since 1.0.0
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkWatchedMessage</span>(<span class="hljs-params">message</span>)</span>{
  <span class="hljs-keyword">return</span> __ENV.__WATCHED_MESSAGES.find(<span class="hljs-function"><span class="hljs-params">watched</span> =&gt;</span> watched.MESSAGE_ID === message.id)
}

__ENV.__VALARIUM_CLIENT.on(<span class="hljs-string">'raw'</span>, packet =&gt; {
  <span class="hljs-keyword">try</span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>We don’t want this to run on unrelated packets</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (![<span class="hljs-string">'MESSAGE_REACTION_ADD'</span>, <span class="hljs-string">'MESSAGE_REACTION_REMOVE'</span>].includes(packet.t)) <span class="hljs-keyword">return</span>

    <span class="hljs-keyword">const</span> channel = __ENV.__VALARIUM_CLIENT.channels.get(packet.d.channel_id)</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>if (channel.messages.has(packet.d.message_id)) return
TODO: Add listener for cached messages to allow for better speed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
    channel.fetchMessage(packet.d.message_id).then(<span class="hljs-function"><span class="hljs-params">message</span> =&gt;</span> {
      <span class="hljs-keyword">let</span> watchedMessage = checkWatchedMessage(message)

      <span class="hljs-keyword">if</span>(watchedMessage != <span class="hljs-literal">null</span> &amp;&amp; watchedMessage != <span class="hljs-literal">undefined</span>){
        __ENV.__VALARIUM_GUILD().fetchMember(packet.d.user_id)
          .then(<span class="hljs-function"><span class="hljs-params">member</span>=&gt;</span>{
            <span class="hljs-keyword">let</span> reaction = watchedMessage.WATCHED_REACTIONS.find(<span class="hljs-function"><span class="hljs-params">reaction</span> =&gt;</span> reaction.REACTION_NAME === packet.d.emoji.name)
            <span class="hljs-keyword">if</span>(reaction != <span class="hljs-literal">null</span> &amp;&amp; reaction != <span class="hljs-literal">undefined</span>){
              member.addRole(reaction.REACTION_ROLE_ID)
              member.createDM()
                .then(<span class="hljs-function"><span class="hljs-params">DMChannel</span>=&gt;</span>{
                  DMChannel.send(<span class="hljs-string">`You've been granted role <span class="hljs-subst">${reaction.REACTION_ROLE_NAME}</span>`</span>)
                })
            }
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span>
          })
          .catch(<span class="hljs-function"><span class="hljs-params">rejection</span>=&gt;</span>{
            <span class="hljs-built_in">console</span>.log(rejection)
          })
      }
    })
  }
  <span class="hljs-keyword">catch</span>(err){
    <span class="hljs-built_in">console</span>.log(err)
  }
})

__ENV.__VALARIUM_CLIENT.login(token)</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>const President = <strong>ENV.</strong>VALARIUM_GUILD().roles.find(role =&gt; role.name === “President”)
const Leaders = <strong>ENV.</strong>VALARIUM_GUILD().roles.find(role =&gt; role.name === “Leaders”)</p>

            </div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>const allowedRoles = {
  other: [
    President, //President
    Leaders, //Leaders
    Organisers, //Organisers
    Contributors
  ],
  moderation: [
    ‘571716246660448318’, //President
    ‘571705643073929226’, //Leaders
  ],
}</p>

            </div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>THIS BOT API IS BASED AS FOLLOWS: 
PREFIX COMMAND_TYPE COMMAND_NAME COMMAND_PARAMETER
val! mod ban userMention
val! misc ping</p>

            </div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>NEW USERS HANDLING</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>__ENV.__VALARIUM_CLIENT.on(<span class="hljs-string">'guildMemberAdd'</span>, member=&gt;{
  <span class="hljs-keyword">const</span> Organisers = __ENV.__VALARIUM_GUILD().roles.find(<span class="hljs-function"><span class="hljs-params">role</span> =&gt;</span> role.name === <span class="hljs-string">"Organisers"</span>)
  <span class="hljs-keyword">const</span> Contributors = __ENV.__VALARIUM_GUILD().roles.find(<span class="hljs-function"><span class="hljs-params">role</span> =&gt;</span> role.name === <span class="hljs-string">"Contributors"</span>)

  member.addRole(<span class="hljs-string">'586951260259876875'</span>)
    .catch(<span class="hljs-built_in">console</span>.error)
  
  member.createDM()
    .then(<span class="hljs-function"><span class="hljs-params">DMChannel</span>=&gt;</span>{
      DMChannel.send(<span class="hljs-string">`Hey, <span class="hljs-subst">${member.displayName}</span>, Welcome to Valarium :tada::hugging:! We are glad to have you with us! Please consider reading the &lt;#571718462179770369&gt; and getting yourself some &lt;#586620199457914904&gt; :wink: before heading to &lt;#571721246362959919&gt; to contribute to our great community!`</span>)
      .catch(<span class="hljs-built_in">console</span>.error)
    })
    .catch(<span class="hljs-built_in">console</span>.error)

  <span class="hljs-keyword">const</span> channel = member.guild.channels.find(<span class="hljs-function"><span class="hljs-params">ch</span> =&gt;</span> ch.name === <span class="hljs-string">'ｖ﹞main-chat'</span>)

  <span class="hljs-keyword">if</span>(channel) channel.send(<span class="hljs-string">`Everyone, greet <span class="hljs-subst">${member}</span>! Welcome to Valarium, your new home! :sweat_smile::raised_hands::fireworks:  <span class="hljs-subst">${Contributors}</span> <span class="hljs-subst">${Organisers}</span>`</span>).catch(<span class="hljs-built_in">console</span>.error)
})

<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isAllowedToUseCommand</span>(<span class="hljs-params">commandMessage, args, __ENV, type</span>)</span>{ <span class="hljs-comment">//type=mod</span>
  <span class="hljs-keyword">let</span> userRoles = (<span class="hljs-keyword">await</span> __ENV.__VALARIUM_GUILD().fetchMember(commandMessage.author.id)).roles.map(<span class="hljs-function"><span class="hljs-params">role</span> =&gt;</span> role.name)
  
  <span class="hljs-keyword">if</span>( type === <span class="hljs-string">'DANGEROUS'</span> ) <span class="hljs-keyword">return</span> commandMessage.member.hasPermission(<span class="hljs-string">'Administrator'</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">true</span>)
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>( type === <span class="hljs-string">'mod'</span> ) <span class="hljs-keyword">return</span> userRoles.some( <span class="hljs-function"><span class="hljs-params">role</span> =&gt;</span> role === <span class="hljs-string">'Leaders'</span> || role ===<span class="hljs-string">'President'</span> )
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>( type === <span class="hljs-string">'org'</span> ) <span class="hljs-keyword">return</span> userRoles.some( <span class="hljs-function"><span class="hljs-params">role</span> =&gt;</span> role === <span class="hljs-string">'Leaders'</span> || role ===<span class="hljs-string">'President'</span> || role === <span class="hljs-string">'Organisers'</span> )
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> userRoles.some( <span class="hljs-function"><span class="hljs-params">role</span> =&gt;</span> role === <span class="hljs-string">'Leaders'</span> || role === <span class="hljs-string">'President'</span> || role === <span class="hljs-string">'Organisers'</span> )
}

__ENV.__VALARIUM_CLIENT.on(<span class="hljs-string">'message'</span>, <span class="hljs-keyword">async</span> message =&gt; {
  <span class="hljs-keyword">try</span>{
    <span class="hljs-keyword">let</span> args = message.content.split(<span class="hljs-string">' '</span>)
    <span class="hljs-keyword">if</span>(args[<span class="hljs-number">0</span>] === prefix){
      __ENV.__DATABASE_OBJECT.collection(<span class="hljs-string">'RECORDED_COMMANDS'</span>).insertOne({<span class="hljs-attr">command</span>: message.content, <span class="hljs-attr">author</span>: message.member.displayName})
      <span class="hljs-keyword">if</span>(<span class="hljs-keyword">await</span> isAllowedToUseCommand(message, args, __ENV, args[<span class="hljs-number">1</span>])){
        <span class="hljs-keyword">if</span> (BOT_COMMANDS.hasOwnProperty(args[<span class="hljs-number">1</span>])) {
          <span class="hljs-keyword">if</span>(BOT_COMMANDS[args[<span class="hljs-number">1</span>]].hasOwnProperty(args[<span class="hljs-number">2</span>])){ <span class="hljs-comment">//allowed commands channel ---- (args.length === 4? commands.hasOwnProperty(args[3]):true)</span>
            BOT_COMMANDS[args[<span class="hljs-number">1</span>]][args[<span class="hljs-number">2</span>]].call(<span class="hljs-keyword">this</span>, message, args, __ENV)
          }
          <span class="hljs-keyword">else</span> <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`I couldn't recognise that`</span>)
        }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`I couldn't recognise that`</span>)
      }
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`You don't have permission to use that command`</span>)
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(insults.test(message.content)){ <span class="hljs-comment">//insults handling</span>
      
      BOT_COMMANDS.mod.warn.call(<span class="hljs-keyword">this</span>, message, <span class="hljs-string">`val! mod warn <span class="hljs-subst">${message.member.id}</span> Swearing This user has used a swear word/insulted someone`</span>.split(<span class="hljs-string">' '</span>), __ENV)
      setTimeout(<span class="hljs-function"><span class="hljs-params">()</span>=&gt;</span>{
        message.delete()
          .catch(<span class="hljs-built_in">console</span>.error)
      }, <span class="hljs-number">1000</span>)
    }
  }
  <span class="hljs-keyword">catch</span>(err){<span class="hljs-built_in">console</span>.log(err.message)}
})</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
